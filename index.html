<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFP Eval</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <link rel="manifest" href="manifest.webmanifest">

</head>

<body>
    <div id="app">
        <div id="chat-screen">
            <div class="header">
                <div class="header-title">
                    <h1>RFP Eval</h1>
                </div>
                <div class="header-actions">
                    <button id="help-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </button>
                    <button id="history-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 4v6h6"></path>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                        </svg>
                    </button>
                    <button id="clear-history-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                    <button id="profile-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"
                            fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="chat-window"></div>
            <div class="timer-container" id="timer-container" style="display: none;">
                <span class="timer-text" id="timer-text"></span>
            </div>
            <div class="disclaimer">AI can make mistakes, verify before acting on recommendations</div>

            <form id="chat-form">
                <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off" required />
                <input type="file" id="file-input" accept=".pdf" style="display:none;" />
                <button type="button" id="file-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                        </path>
                    </svg>
                </button>
                <button type="submit" class="icon-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>
        <div id="profile-screen" style="display: none;">
            <div class="header">
                <button id="back-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"></path>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </button>
                <h1>Profile</h1>
            </div>
            <div class="profile-container">
                <div class="profile-section">
                    <h2>API Provider</h2>
                    <div id="api-provider-section">
                        <select id="api-provider">
                        </select>
                        <input type="text" id="api-base-url" placeholder="Enter custom API base URL"
                            style="display: none;" />
                        <div id="api-key-container">
                        <input type="password" id="api-key" placeholder="API Key" />
                        <button id="toggle-api-key-visibility">
                            <svg id="eye-open" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor"
                                stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <svg id="eye-closed" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor"
                                stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"
                                style="display: none;">
                                <path
                                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                                </path>
                                <line x1="1" y1="1" x2="23" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                        <button id="verify-provider">Verify Provider and Fetch Models</button>
                    </div>
                </div>
                <div class="profile-section" id="model-selection-section" style="display: none;">
                    <h2>Model</h2>
                    <select id="model-select"></select>
                    <button id="save-provider">Save Provider</button>
                </div>
                <div class="profile-section">
                    <h2>System Prompt</h2>
                    <div id="company-profile-section">
                        <textarea id="company-profile-markdown"
                            placeholder="Enter System Prompt in Markdown..."></textarea>
                        <button id="save-profile">Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="company-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-company-profile">&times;</span>
            <h2>Set System Prompt</h2>
            <p>It seems you haven't set your System Prompt yet. Please set it below.</p>
            <textarea id="modal-company-profile-markdown" placeholder="Enter System Prompt in Markdown..."></textarea>
            <button id="save-modal-profile">Save Profile</button>
        </div>
    </div>
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>How to use the RFP Eval App</h2>
            <ol>
                <li>Go to the profile page by clicking the profile icon.</li>
                <li>Set up your API key and provider.</li>
                <li>Fetch and save the models.</li>
                <li>Optionally, add a System Prompt.</li>
                <li>Go back to the chat screen.</li>
                <li>You can now start chatting or upload a PDF RFP document.</li>
            </ol>
        </div>
    </div>
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-history">&times;</span>
            <h2>Chat History</h2>
            <div id="history-table-container">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th data-sort="timestamp">Date</th>
                            <th data-sort="model">Model</th>
                            <th data-sort="api">API Provider</th>
                            <th data-sort="tokens">Tokens</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="history-content"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <script>
        
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        const converter = new showdown.Converter({ tables: true });

        const chatScreen = document.getElementById('chat-screen');
        const profileScreen = document.getElementById('profile-screen');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const fileBtn = document.getElementById('file-btn');
        const apiKeyInput = document.getElementById('api-key');

        const companyProfileMarkdown = document.getElementById('company-profile-markdown');
        const saveProfileBtn = document.getElementById('save-profile');
        const profileBtn = document.getElementById('profile-btn');
        const backBtn = document.getElementById('back-btn');

        const apiProviderSelect = document.getElementById('api-provider');
        const apiBaseUrlInput = document.getElementById('api-base-url');
        const verifyProviderBtn = document.getElementById('verify-provider');
        const modelSelectionSection = document.getElementById('model-selection-section');
        const modelSelect = document.getElementById('model-select');
        const saveProviderBtn = document.getElementById('save-provider');

        let activeProvider = null;
        let pdfText = '';
        let chatHistory = [];
        let sortColumn = 'timestamp';
        let sortDirection = 'desc';

        function loadProviderSettings() {
            const settings = localStorage.getItem('provider_settings');
            if (settings) {
                providerSettings = JSON.parse(settings);
            } else {
                providerSettings = [
                    { name: 'Ollama', baseUrl: 'http://localhost:11434/v1', apiKey: '', model: 'gemma3:1b' },
                    { name: 'OpenAI', baseUrl: 'https://api.openai.com', apiKey: '', model: 'gpt-4o-mini' },
                    { name: 'Gemini', baseUrl: 'https://generativelanguage.googleapis.com/v1beta/openai', apiKey: '', model: 'models/gemini-flash-lite-latest' },
                    { name: 'grok', baseUrl: 'https://api.x.ai/v1', apiKey: '', model: 'Grok-3-mini' },
                    { name: 'Custom', baseUrl: '', apiKey: '', model: '' }
                ];
            }

            const activeProviderUrl = localStorage.getItem('active_provider_url');
            if (activeProviderUrl) {
                activeProvider = providerSettings.find(p => p.baseUrl === activeProviderUrl);
            }

            if (!activeProvider) {
                activeProvider = providerSettings[0];
            }
        }

        function populateProfileUI() {
            if (!activeProvider) return;

            apiProviderSelect.innerHTML = '';
            providerSettings.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.name === 'Custom' ? 'custom' : provider.baseUrl;
                option.textContent = provider.name;
                apiProviderSelect.appendChild(option);
            });

            const isStandardProvider = providerSettings.slice(0, 4).some(p => p.baseUrl === activeProvider.baseUrl && p.name !== 'Custom');

            if (isStandardProvider) {
                apiProviderSelect.value = activeProvider.baseUrl;
                apiBaseUrlInput.value = activeProvider.baseUrl;
                apiBaseUrlInput.style.display = 'none';
                apiBaseUrlInput.readOnly = true;
            } else {
                apiProviderSelect.value = 'custom';
                apiBaseUrlInput.value = activeProvider.baseUrl;
                apiBaseUrlInput.style.display = 'block';
                apiBaseUrlInput.readOnly = false;
            }
            // apiBaseUrlInput.style.display = 'block';

            apiKeyInput.value = activeProvider.apiKey || '';

            modelSelect.innerHTML = '';
            if (activeProvider.model) {
                const option = document.createElement('option');
                option.value = activeProvider.model;
                option.textContent = activeProvider.model;
                modelSelect.appendChild(option);
                modelSelect.value = activeProvider.model;
                modelSelectionSection.style.display = 'block';
            } else {
                modelSelectionSection.style.display = 'none';
            }
        }

        loadProviderSettings();
        const easymde = new EasyMDE({ element: companyProfileMarkdown });


        const savedProfile = localStorage.getItem('company_profile');

        // Load System Prompt from local storage
        if (savedProfile) {
            easymde.value(savedProfile);
        }


        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer-text');
        let isRunning = false;
        let startTime = 0;
        let elapsedTime = 0;
        let timerDuration = 0;
        let showTime = "00:00:00";

        function formatTime(ms) {
            let totalSeconds = Math.floor(ms / 1000);
            let hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            let minutes = Math.floor(totalSeconds / 60);
            let seconds = totalSeconds % 60;

            return [hours, minutes, seconds]
                .map(unit => String(unit).padStart(2, '0'))
                .join(':');
        }

        function startTimer() {
            timerContainer.style.display = 'block';

            if (!isRunning) {
                startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(() => {
                    elapsedTime = Date.now() - startTime;
                    timerDisplay.textContent = formatTime(elapsedTime);
                }, 3000); // Update every 3 second

                isRunning = true;
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            elapsedTime = Date.now() - startTime;
            showTime = formatTime(elapsedTime);
            timerContainer.style.display = 'none';

            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
            }
        }



        // Save System Prompt to local storage
        //const saveProfileBtn = document.getElementById('save-profile');
        saveProfileBtn.onclick = () => {
            const profile = easymde.value();
            localStorage.setItem('company_profile', profile);
            alert('System Prompt saved!');
        };
        function profileButtonClicked() {
            console.log("Profile button clicked");
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('profile-screen').style.display = 'block';
        }

        //----
        // const companyProfileMarkdown = document.getElementById('company-profile-markdown');
        //    const easymde = new EasyMDE({ element: companyProfileMarkdown });
        // Load System Prompt from local storage
        //    const savedProfile = localStorage.getItem('company_profile');
        if (savedProfile) {
            easymde.value(savedProfile);
        }
        // Save System Prompt to local storage
        //const saveProfileBtn = document.getElementById('save-profile');
        saveProfileBtn.onclick = () => {
            const profile = easymde.value();
            localStorage.setItem('company_profile', profile);
            alert('System Prompt saved!');
        };
        function profileButtonClicked() {
            console.log("Profile button clicked");
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('profile-screen').style.display = 'block';
        }

        //---
        profileBtn.onclick = () => {
            chatScreen.style.display = 'none';
            profileScreen.style.display = 'block';
            console.log('Switched to profile screen');
            const savedProfile = localStorage.getItem('company_profile');
            if (savedProfile) {
                easymde.value(savedProfile);
            }
            populateProfileUI();
        };

        backBtn.onclick = () => {
            chatScreen.style.display = 'block';
            profileScreen.style.display = 'none';
        };



        fileBtn.onclick = () => {
            fileInput.click();
        };

        apiProviderSelect.onchange = () => {
            const selectedValue = apiProviderSelect.value;
            if (selectedValue === 'custom') {
                activeProvider = providerSettings.find(p => p.name === 'Custom');
                apiBaseUrlInput.style.display = 'block';
            } else {
                activeProvider = providerSettings.find(p => p.baseUrl === selectedValue);
                apiBaseUrlInput.style.display = 'none';
            }

            localStorage.setItem('active_provider_url', activeProvider.baseUrl);
            populateProfileUI();
        };

        verifyProviderBtn.onclick = async () => {
            let url = (apiProviderSelect.value === 'custom') ? apiBaseUrlInput.value : apiProviderSelect.value;

            if (!url) {
                alert('Please select a provider or enter a custom URL.');
                return;
            }

            try {
                const response = await fetch(`${url}/models`, {
                    headers: {
                        'Authorization': `Bearer ${apiKeyInput.value}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch models. [${url}/models]`);
                }

                const data = await response.json();
                const models = data.data;

                modelSelect.innerHTML = '';
                models.forEach((m) => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = m.id;
                    modelSelect.appendChild(option);
                });

                modelSelectionSection.style.display = 'block';

                if (apiProviderSelect.value === 'custom') {
                    activeProvider.baseUrl = url;
                    localStorage.setItem('provider_settings', JSON.stringify(providerSettings));
                    localStorage.setItem('active_provider_url', url);
                }

            } catch (error) {
                alert(`Could not connect to the API provider. Please check the URL and API key.\n error:[${error}]\n key:[${apiKeyInput.value}]`);
            }
        };

        saveProviderBtn.onclick = () => {
            if (!activeProvider) return;

            activeProvider.apiKey = apiKeyInput.value;
            if (apiProviderSelect.value === 'custom') {
                activeProvider.baseUrl = apiBaseUrlInput.value;
            }

            if (modelSelect.value) {
                activeProvider.model = modelSelect.value;
            }

            localStorage.setItem('provider_settings', JSON.stringify(providerSettings));
            localStorage.setItem('active_provider_url', activeProvider.baseUrl);
            alert('Provider settings saved!');
        };

        fileInput.onchange = async () => {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                appendMessage('user', '[PDF uploaded: ' + file.name + ']');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target?.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        text += textContent.items.map((s) => s.str).join(' ');
                    }
                    pdfText = text;
                };
                reader.readAsArrayBuffer(file);
                const message = userInput.value.trim();
                if (!message || message === '') {
                    message = "Summarize the above RFP and match with the System Prompt for fitment.";
                };
            }
        };

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message || message === '') {
                message = "Summarize the above RFP and match with the System Prompt for fitment.";
            };

            if (!activeProvider.baseUrl || !activeProvider.model) {
                alert('Please configure your provider and model in the profile page.');
                chatScreen.style.display = 'none';
                profileScreen.style.display = 'block';
                return;
            }

            let finalMessage = message;
            if (pdfText) {
                finalMessage = `There is the RFP text : ${pdfText}\n\nUser Prompt:\n${message}`;
                // pdfText = ''; // Clear the pdfText after using it
            } else {
                alert('Please upload a PDF RFP document for evaluation.');
                return;
            }

            appendMessage('user', message);
            userInput.value = '';
            console.log('Sending message to OpenAI:\n\n', finalMessage);

            await sendMessageToOpenAI(finalMessage);

        };

        function appendMessage(role, content) {
            const msgDiv = document.createElement('div');
            msgDiv.className = role;
            const htmlContent = converter.makeHtml(content);
            msgDiv.innerHTML = `${role === 'user' ? 'You' : 'Assistant'}: ${htmlContent}`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessageToOpenAI(message) {
            const savedProfile = localStorage.getItem('company_profile') || '';
            if (savedProfile == '') {
               alert('Please set your System Prompt in the profile page.');
               chatScreen.style.display = 'none';
               profileScreen.style.display = 'block';
               return;
            }
            const sysMessage = `You are a RFP (Request for Proposal) evaluation expert, 
            and help match the System Prompt with the RFP,
             for fitment. Evaluate to 3 grades High (good fit), Medium and Low. Also explain the reason for the grade.\n\n
             show your response in markdown format.\n\n
             If the RFP text is too long, summarize it first, then match it with the System Prompt.\n\n
             If the RFP text is not provided, ask the user to upload the RFP document.\n\n
             If the System Prompt is not provided, ask the user to set the System Prompt in the profile page.\n\n
             If the RFP text is provided, use it in your response.\n\n
             here is the System Prompt:\n\n${savedProfile}\n\n 
             
             `
            appendMessage('assistant', '...');
            startTimer();
            let reply = 'No response.';
            let usage = null;
            let data = null;
            try {
                const response = await fetch(`${activeProvider.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${activeProvider.apiKey}`
                    },
                    body: JSON.stringify({
                        model: activeProvider.model,
                        messages: [
                            {
                                role: "system",
                                content: sysMessage
                            },
                            { role: 'user', content: message }]
                    })
                });
                data = await response.json();
                reply = data.choices?.[0]?.message?.content || 'No response.';
                usage = data.usage;

                const lastMsg = chatWindow.querySelector('.assistant:last-child');
                if (lastMsg) lastMsg.innerHTML = `Assistant: ${converter.makeHtml(reply)}`;
            } catch (err) {
                const lastMsg = chatWindow.querySelector('.assistant:last-child');
                if (lastMsg) lastMsg.textContent = 'Assistant: Error contacting the API provider.';
            } finally {
                stopTimer();
            }
            console.log('Received response from OpenAI:\n\n', reply);
            var curResp = {
                timestamp: getTimestamp(),
                model: activeProvider.model,
                api: activeProvider.baseUrl,
                prompt: message,
                response: data,
                duration: showTime,
                tokens: usage?.total_tokens || null
            }
            saveHistory(curResp);
            const lastMsg = chatWindow.querySelector('.assistant:last-child');
            if (lastMsg) lastMsg.innerHTML += `<div class="stats">[${showTime}, ${curResp.tokens ? curResp.tokens + ' tokens' : 'token count N/A'}]</div>`;
        }

        function getTimestamp() {
            const date = new Date();
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');
            return `${yyyy}${mm}${dd}${hh}${m}${ss}`;
        }
        function saveHistory(cur) {
            let history = JSON.parse(localStorage.getItem('chat_history') || '[]');
            const maxEntries = 200;
            history.unshift(cur);
            if (history.length > maxEntries) {
                history = history.slice(0, maxEntries); // Keep only the latest 200 entries
            }
            localStorage.setItem('chat_history', JSON.stringify(history));
        }

        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeModal = document.getElementsByClassName('close')[0];
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementsByClassName('close-history')[0];
        const historyContent = document.getElementById('history-content');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
        const eyeOpenIcon = document.getElementById('eye-open');
        const eyeClosedIcon = document.getElementById('eye-closed');

        toggleApiKeyVisibilityBtn.onclick = () => {
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                eyeOpenIcon.style.display = 'none';
                eyeClosedIcon.style.display = 'block';
            } else {
                apiKeyInput.type = 'password';
                eyeOpenIcon.style.display = 'block';
                eyeClosedIcon.style.display = 'none';
            }
        };

        helpBtn.onclick = function () {
            helpModal.style.display = "block";
        }

        closeModal.onclick = function () {
            helpModal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == helpModal) {
                helpModal.style.display = "none";
            }
            if (event.target == historyModal) {
                historyModal.style.display = "none";
            }
        }

        function renderHistory() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = '';
            chatHistory.forEach((item, index) => {
                const row = document.createElement('tr');
                const responseContent = item.response?.choices?.[0]?.message?.content || item.response || 'No response in history';
                const formattedPrompt = converter.makeHtml(item.prompt);
                const formattedResponse = converter.makeHtml(responseContent);

                row.innerHTML = `
                    <td>${formatTimestamp(item.timestamp)}</td>
                    <td>${item.model}</td>
                    <td>${item.api}</td>
                    <td>${item.tokens || 'N/A'}</td>
                    <td><button class="expand-btn" data-index="${index}">&#43;</button></td>
                `;
                historyContent.appendChild(row);

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'history-details';
                detailsRow.style.display = 'none';
                detailsRow.innerHTML = `
                    <td colspan="5">
                        <p><b>Prompt:</b></p>
                        <div>${formattedPrompt}</div>
                        <p><b>Response:</b></p>
                        <div>${formattedResponse}</div>
                    </td>
                `;
                historyContent.appendChild(detailsRow);
            });

            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.onclick = function() {
                    const index = this.getAttribute('data-index');
                    const detailsRow = document.querySelectorAll('.history-details')[index];
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = 'table-row';
                        this.innerHTML = '&#8722;';
                    } else {
                        detailsRow.style.display = 'none';
                        this.innerHTML = '&#43;';
                    }
                }
            });
        }

        historyBtn.onclick = function () {
            chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
            sortHistory();
            renderHistory();
            historyModal.style.display = "block";
        }

        function sortHistory() {
            chatHistory.sort((a, b) => {
                let aValue = a[sortColumn];
                let bValue = b[sortColumn];

                if (sortColumn === 'tokens') {
                    aValue = aValue || 0;
                    bValue = bValue || 0;
                }

                if (aValue < bValue) {
                    return sortDirection === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return sortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        document.querySelectorAll('#history-table th').forEach(th => {
            th.onclick = function() {
                const newSortColumn = this.getAttribute('data-sort');
                if (sortColumn === newSortColumn) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = newSortColumn;
                    sortDirection = 'asc';
                }
                sortHistory();
                renderHistory();
            }
        });

        function formatTimestamp(timestamp) {
            const date = new Date(
                parseInt(timestamp.substring(0, 4)),
                parseInt(timestamp.substring(4, 6)) - 1,
                parseInt(timestamp.substring(6, 8)),
                parseInt(timestamp.substring(8, 10)),
                parseInt(timestamp.substring(10, 12)),
                parseInt(timestamp.substring(12, 14))
            );
            return date.toLocaleString();
        }

        closeHistoryModal.onclick = function () {
            historyModal.style.display = "none";
        }

        clearHistoryBtn.onclick = function () {
            if (confirm('Are you sure you want to clear the chat history?')) {
                localStorage.removeItem('chat_history');
                chatWindow.innerHTML = '';
                alert('Chat history cleared.');
            }
        }

        const companyProfileModal = document.getElementById('company-profile-modal');
        const closeCompanyProfileModal = document.getElementsByClassName('close-company-profile')[0];
        const saveModalProfileBtn = document.getElementById('save-modal-profile');
        const modalCompanyProfileMarkdown = document.getElementById('modal-company-profile-markdown');
        const modalEasymde = new EasyMDE({ element: modalCompanyProfileMarkdown });

        if (!savedProfile) {
            companyProfileModal.style.display = 'block';
        }

        closeCompanyProfileModal.onclick = function() {
            companyProfileModal.style.display = "none";
        }

        saveModalProfileBtn.onclick = function() {
            const profile = modalEasymde.value();
            localStorage.setItem('company_profile', profile);
            easymde.value(profile); // Also update the main editor
            companyProfileModal.style.display = "none";
            alert('System Prompt saved!');
        }

        window.onclick = function (event) {
            if (event.target == helpModal) {
                helpModal.style.display = "none";
            }
            if (event.target == historyModal) {
                historyModal.style.display = "none";
            }
            if (event.target == companyProfileModal) {
                companyProfileModal.style.display = "none";
            }
        }
    </script>
</body>

</html>